<style>
    body {
        margin: min(4vw, 25px);
        font-family: Lato, sans-serif;
    }
    .material-icons { user-select: none; }
    /* Rules for using icons as black on a light background. */
    .material-icons.md-dark { color: rgba(0, 0, 0, 0.54); }
    .material-icons.md-dark.md-inactive { color: rgba(0, 0, 0, 0.26); }

    /* Rules for using icons as white on a dark background. */
    .material-icons.md-light { color: rgba(255, 255, 255, 1); }
    .material-icons.md-light.md-inactive { color: rgba(255, 255, 255, 0.3); }

</style>
<script type="statebus">
    body_width = 750
    margin_left = 32
    post_width = 550

    document.title = 'Braid News'
    window.unslash = (t) -> if t?.startsWith?("/") then t.substr(1) else t

    dom.BODY = ->
        DIV
            width: body_width
            margin: "auto"

            H1
                marginLeft: margin_left
                fontSize: "50px"
                "Braid"
            
            USER()
            BIG_MULTIGRAM()
            SUBMIT_POST()
            POSTS()

    dom.POSTS = ->

        # Local copy of posts, ordered.
        posts = (fetch "/posts").all ? []

        ordered = sort_posts posts

        DIV 
            key: "post-list"
            for post in ordered
                RENDER_POST
                    post: post

    # The layout for a single post, including slidergram and such
    dom.RENDER_POST = (post) ->
        # Subscribe to the post
        if post.key then fetch post
        author = fetch post.user

        c = fetch '/current_user'

        # Compute the domain
        pretty_url = post.url
        functional_url = post.url

        DIV
            key: "post-#{post.key}"
            marginTop: "10px"
            marginBottom: "10px"
            display: "grid"
            grid: "\"icon title slider .\" auto
                   \". domain slider . \" 16px
                    / #{margin_left}px #{post_width + 10}px 1fr #{margin_left}px"
            alignItems: "center"

            AVATAR
                user: author
                gridArea: "icon"
                style:
                    width: margin_left - 10
                    height: margin_left - 10
                    borderRadius: "50%"
                    alignSelf: "start"

            DIV
                gridArea: "title"
                fontSize: "18px"
                paddingRight: "10px"
                lineHeight: "#{margin_left - 10}px"
                justifySelf: "stretch"
                cursor: if post.url.length then "pointer"
                onClick: if post.url.length then (e) ->
                    window.location.assign functional_url
                "#{post.title}"
            SPAN
                gridArea: "domain"
                fontSize: "12px"
                color: "#999"
                "#{pretty_url}"

            DIV
                gridArea: "slider"
                alignSelf: "start"
                height: margin_left - 10
                SLIDERGRAM
                    sldr: "/votes_on#{post.key}"
                    width: body_width - 2*margin_left - post_width - 10
                    height: margin_left - 10
                    max_avatar_radius: (margin_left - 10) / 2
                    read_only: !c.logged_in


    # Information about the current user:
    # Login/Out/Register
    dom.USER = ->
        c = fetch '/current_user'
        s = fetch "show_settings"
        s.show ?= false
        DIV
            position: "absolute"
            top: 15
            right: 30

            DIV {},
                if c.logged_in
                    DIV
                        display: "flex"
                        flexDirection: "row"
                        alignItems: "center"
                        justifyContent: "end"
                        marginBottom: "5px"

                        AVATAR
                            user: c.user
                            style:
                                placeSelf: "center"
                                width: 20
                                height: 20
                                borderRadius: "50%"

                        DIV
                            marginLeft: "6px"
                            marginRight: "6px"
                            c.user.name

                        SPAN
                            className: "material-icons md-dark"
                            fontSize: "20px"
                            cursor: "pointer"
                            marginRight: "5px"
                            onClick: (e) ->
                                s.show = !s.show ? true
                                save s
                            "settings"
                        SPAN
                            className: "material-icons md-dark"
                            fontSize: "20px"
                            cursor: "pointer"
                            onClick: (e) ->
                                c.logout = true
                                save c
                            "logout"
                else if !s.show
                    DIV
                        onClick: (e) ->
                            s.show = !s.show ? true
                            save s
                        fontSize: "14px"
                        color: "#666"
                        cursor: "pointer"
                        "Not Logged In"
            DIV {},
                display: unless s.show then "none"
                if c.logged_in
                    SETTINGS()
                else
                    LOGIN()


    dom.SUBMIT_POST = ->

        has_typed = fetch "submit_open"
        has_typed.typed ?= false

        DIV
            width: post_width
            marginLeft: margin_left
            INPUT
                id: "post-title"
                style:
                    width: post_width
                    height: "28px"
                placeholder: "Say something..."
                onInput: (e) ->
                    has_typed.typed = e.target.value.length > 0
                    save has_typed

            DIV
                display: if has_typed.typed then "flex" else "none"
                flexDirection: "row"
                marginTop: "5px"
                INPUT
                    id: "post-url"
                    type: "url"
                    placeholder: "URL"
                    flexGrow: "1"
                    marginRight: "5px"
                    style:
                        height: "28px"
                SPAN
                    alignSelf: "center"
                    className: "material-icons md-dark"
                    fontSize: "24px"
                    onClick: (e) ->
                        title = document.getElementById("post-title")
                        link = document.getElementById("post-url")
                        if title.value.length > 1
                            make_post title.value, link.value, c.user.key
                            title.value = ""
                            link.value = ""
                    cursor: "pointer"
                    "post_add"

    dom.BIG_MULTIGRAM = ->
        DIV
            width: body_width
            padding: "0 #{margin_left}px 15px #{margin_left}px"

            MULTIGRAM
                sldr: 'multigram'
                width: body_width - 2 * margin_left 
                height: 60
                max_avatar_radius: 30

    # Attempt to add a neutral vote on the specified user.
    # The return value is whether or not *such a vote exists*.
    # That is, returns true if the desired vote already exists or it was created successfuly.
    # Returns false if the user does not exist or we are not logged in.
    add_user_weight = (username) ->
        t = unslash username
        c = fetch "/current_user"
        unless (t.startsWith "user\/" ) and ((fetch "/#{t}").name?) and (c.logged_in) and ((unslash c.user.key) != t)
            return false
        # Ok, the input is the username of a real user, and we are also logged in.
        # But have we already voted on them?
        key = "/votes/_#{unslash c.user.key}_#{t}_"
        if (fetch key).value?
            # Also clear the input
            return true
        # Ok, we have not voted on this user yet.
        # Make a default vote.
       
        votes = fetch "/votes_on/#{t}"
        votes.values ?= []
        votes.values.push
            user: c.user.key
            value: 0.5
            key: key
            target: "/#{t}"

        save votes

        return true

    multigram_aux = {}

    bus('multigram').to_fetch = () ->
        c = fetch "/current_user"
        unless c.logged_in
            return {key: 'multigram'}

        votes_arr = Object.values(fetch "/votes_by#{c.user.key}")
            .filter (v) ->
                unless v.target?
                    return false
                (unslash v.target).startsWith "user"
            .map (v) ->
                # Subscribe to each individual vote...
                fetch v
                # Now make a copy of it that isnt tied to the real state url
                t = Object.assign {}, v
                delete t.key
                t

        # if we want to "suggest" users in the extended network that could be voted on, we should pull them from "weights" and include them here.

        Object.assign multigram_aux, {values: votes_arr}

    bus('multigram').to_save = (val, t) ->

        #// Save the auxilliary data
        Object.assign multigram_aux, val
        #// We don't actually want to save thing like mouse state to the server, but we need to keep a copy of it.

        #// The multigram can't add new values, so we just have to save the values in it to the server.
        #// Ie, the multigram has an array of values, each of which is an actual vote state.
        #// But, we only save these if the user is done dragging!
        unless val.dragging
            val.values.forEach (v) ->
                cop = Object.assign {}, v
                cop.key = "/votes/_#{unslash v.user}_#{unslash v.target}_"
                save cop
        #// Then save it:
        t.done val


</script>
<script src="https://stateb.us/client6.js" server="/"></script>
<script src="/coffee/post.coffee" crossorigin=anonymous></script>
<script src="/coffee/login.coffee" crossorigin=anonymous></script>

<!-- For slidergrams -->

<script src="https://considerit.us:3006/client/shared.coffee"></script>
<script src="/coffee/avatar.coffee" crossorigin=anonymous></script>
<script src="/coffee/slidergrams.coffee" crossorigin=anonymous></script>
<script src="/coffee/multigrams.coffee" crossorigin=anonymous></script>

<script src="https://considerit.us:3006/static/vendor/md5.js"></script>
<script src="https://considerit.us:3006/static/vendor/d3.quadtree.js"></script>

<!-- Google Fonts: Lato -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

