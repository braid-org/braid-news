<!DOCTYPE html>
<html>
<head>
<meta charset=UTF-8>
<title>Braid News</title>
<style>
    body {
        margin: min(4vw, 25px);
        font-family: Lato, sans-serif;
    }
    .material-icons { user-select: none; }
    /* Rules for using icons as black on a light background. */
    .material-icons.md-dark { color: rgba(0, 0, 0, 0.54); }
    .material-icons.md-dark.md-inactive { color: rgba(0, 0, 0, 0.26); }

    /* Rules for using icons as white on a dark background. */
    .material-icons.md-light { color: rgba(255, 255, 255, 1); }
    .material-icons.md-light.md-inactive { color: rgba(255, 255, 255, 0.3); }

    .post-title:link {
        color: black;
    }
    .post-title:visited {
        color: #777;
    }
    .post-title:hover {
        color: #111;
    }
    .tooltip {
        width: -moz-fit-content;
        width: -webkit-fit-content;
        width: fit-content;
    }
    .hover-select:hover {
        background-color: #eee;
    }

</style>

<script type=coffee>
    body_width = 800
    margin_left = 40
    post_width = 575

    document.title = 'Braid News'
    window.unslash = (t) -> if t?.startsWith?("/") then t.substr(1) else t
    window.slash = (t) -> if t?.startsWith?("/") then t else "/#{t}"
    
    window.change_path = (path) ->
        u = new URL window.location.href
        u.pathname = path
        history.pushState {}, '', u

    window.parse_path = (path) ->
        path = unslash path
        v = fetch "view"
        v.selected = switch
            when path.startsWith "tag"
                tagname = (path.substr 4).toLowerCase()
                {
                    _key: "/#{tagname}",
                    name: tagname,
                    type: "tag"
                }
            when path.startsWith "user"
                {
                    _key: slash path,
                    name: path.substr 5
                    type: "user"
                }
            else
                null
        save v

    window.load_path = (path) ->
        change_path path
        parse_path path


    parse_path ((new URL window.location.href).pathname)

    dom.BODY = ->
        DIV
            key: "body"
            width: body_width
            margin: "auto"

            HEADER()
            BIG_MULTIGRAM()
            POSTS()

    dom.POSTS = ->

        # Local copy of posts, ordered.
        c = fetch "/current_user"
        posts = (fetch "/posts").all ? []
        v = fetch "view"

        username = c?.user?.key ? "/user/default"

        ordered = switch
            when v?.selected?.type == "user" then sort_posts posts, v.selected._key
            when v?.selected?.type == "tag" then sort_posts posts, username, v.selected._key
            else sort_posts posts, username

        DIV 
            key: "post-list"
            for post in ordered
                POST
                    post: post


    dom.BIG_MULTIGRAM = ->
        c = fetch "/current_user"
        v = fetch "view"
        username = switch
            when v?.selected?.type == "user" then v.selected._key
            when c?.logged_in then c.user.key
            else "/user/default"
        username = unslash username
        DIV
            key: "multigram-wrapper"
            width: body_width
            padding: "0 #{margin_left}px 0 #{margin_left}px"

            MULTIGRAM
                sldr: "usergram/#{username}"
                width: body_width - 2 * margin_left 
                height: 130
                max_avatar_radius: 60
                read_only: (v?.selected?.type == "user") or !c.logged_in
                onsave: (vote) =>
                    delete vote.type
                    copy = Object.assign {}, vote
                    copy.key = "/votes/_#{username}_#{unslash vote.target}_"
                    save copy


</script>

<!-- Main statebus script -->
<script src="/client.js" server="/"></script>
<script src="/static/vendor/considerit_shared.js" crossorigin=anonymous></script>
<script src="/coffee/ui.coffee" crossorigin=anonymous></script>
<script src="/coffee/post.coffee" crossorigin=anonymous></script>

<!-- For slidergrams -->
<script src="/coffee/avatar.coffee" crossorigin=anonymous></script>
<script src="/coffee/slidergrams.coffee" crossorigin=anonymous></script>
<script src="/coffee/multigrams.coffee" crossorigin=anonymous></script>

<script src="https://unpkg.com/blueimp-md5@2.19.0/js/md5.js"></script>
<script src="/static/vendor/quadtree.js"></script>

<!-- Google Fonts: Lato -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg" sizes="any">
</head>
</html>
